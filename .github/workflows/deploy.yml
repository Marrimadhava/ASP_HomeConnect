name: 'Deployment'

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  build:
    name: 'deployment'
    runs-on: ubuntu-latest
    environment: production

    steps:

    - name: checkout 
      uses: actions/checkout@v2

    - name: install SSH key 
      uses: shimataro/ssh-key-action@v2
      with: 
        key: ${{ secrets.EC2_SSH_KEY}}
        known_hosts: ${{ secrets.EC2_HOSTS }}

    - name: deploying in ec2
      run: |
        ssh -o StrictHostKeyChecking=no -i EC2_SSH_KEY ubuntu@18-117-168-125 << 'EOF'
          sudo docker stop myhomecontainer || true
          sudo docker rm myhomecontainer || true
          sudo docker build -t myhome .
          sudo docker run --name myhomecontainer -d -p 5000:8000 myhome
        EOF
